# M5Stamp Fly 技術仕様書

## 1.0 製品概要

本セクションでは、M5Stamp Flyクアッドコプターキットの概要、主要な機能、および想定される応用分野について解説します。M5Stamp Flyは、M5StampS3をメインコントローラーとして採用した、オープンソースのプログラマブルクアッドコプターキットです。その設計は、教育、研究、そして多様なドローン開発プロジェクトにおける戦略的なプラットフォームとなることを目的としています。

M5Stamp Flyの核心的なコンセプトは、高度なセンサーフュージョンによる精密な自律飛行の実現にあります。機体には、姿勢と方位を検出するための6軸ジャイロスコープ（BMI270）と3軸磁力計（BMM150）、正確な高度維持と障害物回避を可能にする気圧センサー（BMP280）および2基の距離センサー（VL53L3）が統合されています（注：1系統のI2Cバスに接続）。さらに、オプティカルフローセンサー（PMW3901MB-TXQT）が地面の変位を捉えることで、GPSのない環境でも安定したホバリングと位置維持を実現します。これらのセンサー群が協調して動作することにより、複雑な環境下でも安定した飛行制御を可能にしています。

M5Stamp Flyの主な特徴は以下の通りです。

- **M5StampS3をメインコントローラーとして採用**: 高性能なXtensa LX7プロセッサとWi-Fi接続機能を備え、高度な演算処理と無線通信を実現します。
- **BMP280による気圧検知**: 大気圧の変化を精密に測定し、安定した高度維持機能の基盤となります。
- **VL53L3距離センサー搭載**: 地面との物理的な距離を直接測定することで、低空での正確な高度維持や障害物回避を可能にします。
- **6軸姿勢センサー内蔵**: 機体の傾きや角速度をリアルタイムに検出し、基本的な姿勢制御を担います。
- **3軸磁力計による方向検知**: 地磁気を基準に機体の絶対的な方角を特定し、正確なナビゲーションを支援します。
- **オプティカルフローセンサーによる変位検知**: 水平方向の移動を高精度に検出し、GPSが利用できない屋内環境などでの位置維持に貢献します。
- **ブザー搭載**: 飛行状態や警告を音でユーザーに通知し、インタラクティブな操作を可能にします。
- **300mAh高電圧パワーバッテリー**: コンパクトながら十分な飛行時間を確保します。
- **電流・電圧検知機能**: バッテリーの状態をリアルタイムで監視し、安全な運用と飛行時間の管理をサポートします。
- **Groveインターフェースによる拡張性**: 外部センサーやモジュールの追加が容易で、プロジェクトの可能性を広げます。

本製品は、その高い機能性と拡張性から、以下のような幅広い分野での活用が期待されます。

- 教育
- 研究
- ドローン開発
- DIYプロジェクト

これらの多彩な機能を実現する具体的なハードウェアコンポーネントについて、次章でさらに詳しく分析していきます。

## 2.0 主要コンポーネント分析

本セクションでは、M5Stamp Flyを構成する主要な電子コンポーネントの役割と性能について詳細に解説します。クアッドコプターの安定した自律飛行は、これらの制御・センサーシステムが緊密に連携することによって初めて実現されます。各コンポーネントがどのように情報を収集・処理し、機体全体の挙動に貢献するのかを理解することは、本製品の能力を最大限に引き出す上で不可欠です。

### メインコントローラー (M5StampS3)

ESP32-S3をベースとするM5StampS3は、本機の中枢を担う頭脳です。高性能なXtensa LX7プロセッサと8MBのフラッシュメモリを搭載し、複雑な飛行制御アルゴリズムやセンサーデータのリアルタイム処理を余裕をもって実行します。内蔵されたWi-Fi機能により、遠隔操作やテレメトリデータの送信、ファームウェアの無線アップデートなどが可能です。また、OTG/CDC機能をサポートしており、USB経由でのデバッグや通信も容易に行えます。

### 6軸姿勢センサー (BMI270)

BMI270は、3軸加速度センサーと3軸ジャイロスコープを統合した慣性計測ユニット（IMU）です。機体の傾き（ロール、ピッチ）や回転（ヨー）をリアルタイムで高精度に検知します。このセンサーから得られるデータは、機体を安定させるためのPID制御ループへの主要な入力となり、あらゆる飛行動作における姿勢維持の根幹をなしています。

### 3軸磁力計 (BMM150)

BMM150は地磁気を検知し、機体の絶対的な方角を特定する役割を担います。このグローバルな基準フレームを提供することで、「ヘッドレスモード」での直感的な操縦や、より高精度な自律航行を可能にします。ただし、磁石を含む製品や強磁性体の近くで使用すると、センサーの読み取り値に異常が生じる可能性があるため、周囲の磁気環境には注意が必要です。

### 気圧センサー (BMP280)

BMP280は、大気圧を精密に測定するセンサーです。高度が上がると気圧が下がる原理を利用して機体の相対的な高度を算出し、指定した高度で安定してホバリングする「高度維持機能」の実現に不可欠です。環境の微細な圧力変化を捉えることで、滑らかな高度制御を可能にします。

### 距離センサー (VL53L3)

VL53L3は、Time-of-Flight（ToF）技術を用いたレーザー測距センサーです。地面などの対象物との物理的な距離を直接、かつ正確に測定します。特に低空飛行時や着陸シーケンスにおいて、気圧センサーよりも高精度な高度情報を提供し、機体の安定性を向上させます。また、障害物回避機能にも応用可能です。

### オプティカルフローセンサー (PMW3901MB-TXQT)

PMW3901MB-TXQTは、地面の模様を追跡することで機体の水平方向の移動（変位）を検知する、一種の「ビジュアルオドメトリ」センサーです。GPS信号が利用できない屋内などの環境において、外乱による機体の流れを検出し、自律的に位置を補正します。これにより、高精度な「ポジションホールド（位置維持）」機能が実現されます。

### 電流/電圧センサー (INA3221AIRGVR)

INA3221AIRGVRは、バッテリーの電圧と消費電流をリアルタイムで監視する重要なコンポーネントです。このセンサーからの情報により、バッテリー残量を正確に把握して飛行可能時間を予測したり、過電流や電圧低下といった異常を検知したりすることが可能となり、機体の安全な運用をサポートします。

これらのコンポーネントの具体的な数値的仕様を一覧で確認し、ハードウェアとしての性能をさらに深く掘り下げていきます。

## 3.0 詳細技術仕様

本セクションでは、M5Stamp Flyの性能と機能を規定する詳細な技術仕様を一覧で示します。ハードウェアの能力を最大限に引き出し、外部コンポーネントとの互換性を確認する上で、これらの正確な数値を把握することは不可欠です。

| 仕様項目 | パラメータ |
|---------|-----------|
| M5StampS3 | ESP32-S3@Xtensa LX7, 8MB Flash, WIFI, OTG/CDC function |
| モーター | 716-17600kv |
| 距離センサー | VL53L3C 0x29(7-bits) @up to 3 meters |
| オプティカルフローセンサー | PMW3901MB-TXQT |
| 気圧センサー | BMP280(0x76)@300-1100hPa |
| 3軸磁力計 | BMM150(0x10) |
| 6軸姿勢センサー | BMI270 |
| Grove | I2C+UART |
| バッテリー | 300mAh 高電圧リチウム電池 |
| バッテリー出力電圧 | 4.35V |
| 飛行時間 | 約4分 |
| 充電時間 (入力:5V@1A) | 55分 |
| 電流/電圧検知 | INA3221AIRGVR(0x40) |
| ブザー | パッシブオンボードブザー@5020 |
| 動作温度 | 0-40°C |
| 製品サイズ | 81.5 x 81.5 x 31mm |
| パッケージサイズ | 162 x 99 x 36mm |
| 製品重量 | 36.8g |
| パッケージ重量 | 70.7g |

これらのハードウェアが物理的にどのように接続されているかを理解するために、次章では各インターフェースのピン配置について詳しく見ていきます。

## 4.0 インターフェースとピンマッピング

本セクションでは、M5Stamp Flyの各インターフェースとM5StampS3コントローラー間のピンマッピングについて詳細に解説します。外部センサーの追加やカスタムファームウェアの開発を行う上で、各ピンの役割と接続先を正確に理解することは極めて重要です。

### 4.1 I2Cインターフェース

I2Cは、2本の信号線（SDA、SCL）を使用して複数のデバイスと通信するシリアルバスです。M5Stamp Flyでは、電流/電圧センサー、磁力計、気圧センサー、距離センサーがこの共有バスに接続されており、効率的なデータ通信を実現しています。

| StampFly (Stamp-S3) | 接続デバイス |
|---------------------|-------------|
| G3 (SDA) | INA3221, BMM150, BMP280, VL53L3 |
| G4 (SCL) | INA3221, BMM150, BMP280, VL53L3 |

### 4.2 SPIインターフェース

SPIは、I2Cよりも高速なデータ転送が可能なシリアル通信プロトコルです。各デバイスは個別のチップセレクト（CS）ピンによって制御されます。M5Stamp Flyでは、高速なデータ読み出しが要求される6軸姿勢センサーとオプティカルフローセンサーがSPIバスに接続されています。

| StampFly (Stamp-S3) | BMI270 | PMW3901MB-TXQT |
|---------------------|--------|----------------|
| G14 | MOSI | MOSI |
| G44 | SCK | SCK |
| G43 | MISO | MISO |
| G46 | CS | - |
| G12 | - | CS2 |

### 4.3 Groveインターフェース

拡張性を確保するため、2系統のGroveインターフェースが用意されています。これにより、はんだ付け不要で市販の多様なサードパーティ製センサーやモジュールを容易に接続でき、プロジェクトの機能を簡単に拡張することが可能です。

- **Grove (RED - I2C)**:
  - G13: SDA
  - G15: SCL
- **Grove (BLACK - UART)**:
  - G1: GROVE I (RX)
  - G2: GROVE O (TX)

### 4.4 VL53L3CX ToFセンサー制御ピン

2基のVL53L3CX距離センサー（前方および底面）は、同一のI2Cアドレスを持つため、XSHUTピンを使用して個別に初期化とアドレス変更を行う必要があります。また、各センサーは割り込みピン（GPIO1/INT）を備えており、測定完了時の通知に使用できます。

- **前方ToFセンサー XSHUT**: G9
- **前方ToFセンサー INT**: G8
- **底面ToFセンサー XSHUT**: G7
- **底面ToFセンサー INT**: G6

### 4.5 その他

ユーザーへのフィードバックや状態表示のために、ブザーとフルカラーRGB LEDが搭載されています。これらの制御ピンは以下の通りです。

- **Buzzer**: G40
- **WS2812 RGB LED**: G39

これらのハードウェアの動作を支える電源システムについて、次章で詳しく解説します。

## 5.0 電源およびバッテリー

本セクションでは、M5Stamp Flyの性能と安全性を確保する上で極めて重要な電源システムとバッテリー管理について詳述します。ドローンの安定した飛行は、信頼性の高い電力供給に依存しており、バッテリーの適切な理解と取り扱いは不可欠です。

M5Stamp Flyには、300mAhの高電圧リチウム電池が搭載されています。このバッテリーは標準的なリチウムポリマー電池よりも高い4.35Vの出力電圧を持ち、コンパクトなサイズでありながら高いエネルギー密度を実現し、約4分間の飛行時間を可能にしています。

安全な運用とバッテリーの寿命を最大化するため、以下の注意点を遵守してください。

- **充電に関する注意事項**:
  - 充電は、本機に付属のバッテリーを、専用リモートコントローラーであるAtom JoyStickの充電スロットに接続し、データケーブルをAtom JoyStickに接続して行ってください。
- **バッテリーのメンテナンス**:
  - 飛行中、バッテリーのセルあたりの電圧が3V以下にならないようにしてください。過放電はバッテリーに深刻なダメージを与えます。
  - 満充電状態のバッテリーを3日以上保管しないでください。長期保管する場合は、電圧を3.8Vから3.9Vの間に保つことが推奨されます。

機体に搭載されたINA3221AIRGVRセンサーは、リアルタイムでバッテリーの電流と電圧を監視します。この機能により、飛行制御システムはバッテリー残量を正確に把握し、低電圧警告を発することができます。また、消費電力のパターンを分析することで、異常な電力消費を検知し、機体の安全性を向上させることにも貢献します。

ハードウェアを制御するためのソフトウェア関連情報について、次章で解説します。

## 6.0 ソフトウェアと開発リソース

本セクションでは、M5Stamp Flyのポテンシャルを最大限に引き出すために提供されているソフトウェア、開発ツール、および技術資料について紹介します。これらのリソースを効果的に活用することが、カスタムアプリケーション開発や研究プロジェクトを成功に導く鍵となります。

以下に、利用可能な主要なリソースをまとめます。

### ファームウェア

- **Arduino**: StampFly Firmware - Arduino IDEを使用してカスタマイズや開発を行うためのファームウェアソースコードです。
- **Easyloader**: StampFly Firmware Easyloader - PCに接続するだけで、手軽に工場出荷時のファームウェアを書き込むことができるツールです。

### 回路図

- **StampS3_Fly_Hat Schematics PDF** - センサーやモータードライバが実装された拡張基板部分の回路図。カスタムハードウェアのデバッグに不可欠です。
- **Stamp_Fly Schematics PDF** - M5StampS3と拡張基板を含む機体全体の統合回路図。
- **PMW3901MB Schematics PDF** - オプティカルフローセンサーモジュールの回路図です。

### 主要コンポーネント データシート

- VL53L3(ToF)
- PMW3901MB-TXQT(Optical Flow Sensor Chip)
- BMP280(Pressure Sensor Chip)
- BMM150(3D Magnetometer Compass)
- BMI270(6-axis Inertial Measurement Unit (IMU) Sensor)

### 3Dモデル

- **Battery Protection Component STL File** - バッテリー保護部品の3Dプリンター用データです。

---

この技術仕様書が、M5Stamp Flyを用いた皆様の教育、研究、そして創造的な開発プロジェクトの確かな出発点となることを願っています。
